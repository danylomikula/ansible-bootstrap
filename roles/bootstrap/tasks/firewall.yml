---
# Firewall configuration tasks (firewalld - universal)
# Note: Skipped in containers (Docker) as firewalld requires kernel access
# Changes applied with immediate: true, reboot at end applies permanent config

- name: Check if running in container
  ansible.builtin.stat:
    path: /.dockerenv
  register: _bootstrap_dockerenv

- name: Skip firewall in container
  ansible.builtin.debug:
    msg: "Firewall configuration skipped in container"
  when: _bootstrap_dockerenv.stat.exists

- name: Disable ufw in favour of firewalld (Debian/Ubuntu)
  community.general.ufw:
    state: disabled
  when:
    - not _bootstrap_dockerenv.stat.exists
    - ansible_facts['os_family'] == 'Debian'
  failed_when: false

- name: Stop unattended-upgrades to release dpkg lock
  ansible.builtin.systemd:
    name: unattended-upgrades
    state: stopped
  when:
    - not _bootstrap_dockerenv.stat.exists
    - ansible_facts['os_family'] == 'Debian'
  failed_when: false

- name: Install firewalld and Python bindings (Debian/Ubuntu)
  ansible.builtin.apt:
    name:
      - firewalld
      - python3-firewall
    state: present
    update_cache: true
  when:
    - not _bootstrap_dockerenv.stat.exists
    - ansible_facts['os_family'] == 'Debian'

- name: Install firewalld (RedHat)
  ansible.builtin.dnf:
    name: firewalld
    state: present
  when:
    - not _bootstrap_dockerenv.stat.exists
    - ansible_facts['os_family'] == 'RedHat'

- name: Start and enable firewalld
  ansible.builtin.systemd:
    name: firewalld
    state: started
    enabled: true
  when: not _bootstrap_dockerenv.stat.exists

# Custom zones - must reload after creating before they can be used
- name: Create custom firewall zones
  ansible.posix.firewalld:
    zone: "{{ item.name }}"
    permanent: true
    state: present
  loop: "{{ bootstrap_firewall_custom_zones | default([]) }}"
  when:
    - not _bootstrap_dockerenv.stat.exists
    - (bootstrap_firewall_custom_zones | default([])) | length > 0
  register: _bootstrap_custom_zones_created

- name: Reload firewalld to apply new zones
  ansible.builtin.command:
    cmd: firewall-cmd --reload
  when:
    - not _bootstrap_dockerenv.stat.exists
    - _bootstrap_custom_zones_created is defined
    - _bootstrap_custom_zones_created.changed | default(false)
  changed_when: true

- name: Assign interfaces to custom zones
  ansible.posix.firewalld:
    zone: "{{ item.name }}"
    interface: "{{ item.interface }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ bootstrap_firewall_custom_zones | default([]) }}"
  when:
    - not _bootstrap_dockerenv.stat.exists
    - (bootstrap_firewall_custom_zones | default([])) | length > 0
    - item.interface is defined

- name: Allow ports in custom zones
  ansible.posix.firewalld:
    zone: "{{ item.0.name }}"
    port: "{{ item.1.port }}/{{ item.1.proto }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ bootstrap_firewall_custom_zones | default([]) | subelements('ports', skip_missing=True) }}"
  when:
    - not _bootstrap_dockerenv.stat.exists
    - (bootstrap_firewall_custom_zones | default([])) | length > 0

- name: Ensure target firewall zone exists
  ansible.posix.firewalld:
    zone: "{{ bootstrap_firewall_zone }}"
    state: present
    permanent: true
  when: not _bootstrap_dockerenv.stat.exists

- name: Allow specified services
  ansible.posix.firewalld:
    service: "{{ item }}"
    zone: "{{ bootstrap_firewall_zone }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ bootstrap_firewall_services }}"
  when:
    - not _bootstrap_dockerenv.stat.exists
    - (bootstrap_firewall_services | default([])) | length > 0

- name: Allow specified ports
  ansible.posix.firewalld:
    port: "{{ item.port }}/{{ item.proto }}"
    zone: "{{ bootstrap_firewall_zone }}"
    permanent: true
    immediate: true
    state: enabled
  loop: "{{ bootstrap_firewall_ports }}"
  when:
    - not _bootstrap_dockerenv.stat.exists
    - (bootstrap_firewall_ports | default([])) | length > 0

- name: Allow ICMP echo-request
  ansible.posix.firewalld:
    icmp_block: echo-request
    zone: "{{ bootstrap_firewall_zone }}"
    permanent: true
    immediate: true
    state: disabled
  when:
    - not _bootstrap_dockerenv.stat.exists
    - bootstrap_firewall_allow_icmp | default(true)

- name: Block ICMP echo-request
  ansible.posix.firewalld:
    icmp_block: echo-request
    zone: "{{ bootstrap_firewall_zone }}"
    permanent: true
    immediate: true
    state: enabled
  when:
    - not _bootstrap_dockerenv.stat.exists
    - not (bootstrap_firewall_allow_icmp | default(true))

- name: Check current default zone
  ansible.builtin.command:
    cmd: firewall-cmd --get-default-zone
  register: _bootstrap_firewall_current_zone
  changed_when: false
  when: not _bootstrap_dockerenv.stat.exists

- name: Set default zone
  ansible.builtin.command:
    cmd: firewall-cmd --set-default-zone={{ bootstrap_firewall_zone }}
  when:
    - not _bootstrap_dockerenv.stat.exists
    - _bootstrap_firewall_current_zone.stdout | default('') != bootstrap_firewall_zone
  changed_when: true
