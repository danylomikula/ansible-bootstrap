---
# Network configuration tasks (static IP via NetworkManager)

- name: Check if NetworkManager is available
  ansible.builtin.command: nmcli -v
  register: _bootstrap_nmcli_check
  changed_when: false
  failed_when: false

- name: Install NetworkManager (Debian/Ubuntu)
  ansible.builtin.apt:
    name: network-manager
    state: present
    update_cache: true
  when:
    - _bootstrap_nmcli_check.rc != 0
    - ansible_facts['os_family'] == 'Debian'

- name: Install NetworkManager (RedHat)
  ansible.builtin.dnf:
    name: NetworkManager
    state: present
  when:
    - _bootstrap_nmcli_check.rc != 0
    - ansible_facts['os_family'] == 'RedHat'

- name: Ensure NetworkManager is running
  ansible.builtin.systemd:
    name: NetworkManager
    state: started
    enabled: true

- name: Get default network connection name
  ansible.builtin.shell: |
    set -o pipefail
    nmcli -t -f NAME,DEVICE con show --active | grep -E ':(eth|en|wl)' | head -1 | cut -d: -f1
  args:
    executable: /bin/bash
  register: _bootstrap_nmcli_connection
  changed_when: false
  when: bootstrap_network_connection | default('') | length == 0

- name: Set connection name fact
  ansible.builtin.set_fact:
    _bootstrap_network_connection: "{{ bootstrap_network_connection if bootstrap_network_connection | default('') | length > 0 else _bootstrap_nmcli_connection.stdout }}"

# Fail fast if we cannot determine a connection name
- name: Ensure network connection name is set
  ansible.builtin.fail:
    msg: "Unable to determine NetworkManager connection name. Set bootstrap_network_connection explicitly."
  when: _bootstrap_network_connection | default('') | length == 0

# Network changes applied on reboot - no need to restart connection mid-playbook
- name: Configure static IPv4
  community.general.nmcli:
    conn_name: "{{ _bootstrap_network_connection }}"
    type: ethernet
    ip4: "{{ bootstrap_static_ip }}"
    gw4: "{{ bootstrap_gateway }}"
    dns4: "{{ bootstrap_dns4 }}"
    dns4_ignore_auto: "{{ bootstrap_dns4_ignore_auto | default(true) }}"
    method4: manual
    state: present
  when:
    - bootstrap_static_ip | default('') | length > 0
    - bootstrap_gateway | default('') | length > 0

- name: Configure static IPv6 (manual mode)
  community.general.nmcli:
    conn_name: "{{ _bootstrap_network_connection }}"
    type: ethernet
    ip6: "{{ bootstrap_static_ip6 }}"
    gw6: "{{ bootstrap_gateway6 }}"
    dns6: "{{ bootstrap_dns6 }}"
    dns6_ignore_auto: "{{ bootstrap_dns6_ignore_auto | default(true) }}"
    method6: manual
    state: present
  when:
    - bootstrap_static_ip6 | default('') | length > 0
    - bootstrap_gateway6 | default('') | length > 0
    - not (bootstrap_ipv6_dhcpv6 | default(false))

# Auto mode with additional static address (for DHCPv6/SLAAC + ULA)
- name: Configure IPv6 with DHCPv6/SLAAC
  community.general.nmcli:
    conn_name: "{{ _bootstrap_network_connection }}"
    type: ethernet
    dns6: "{{ bootstrap_dns6 }}"
    dns6_ignore_auto: "{{ bootstrap_dns6_ignore_auto | default(true) }}"
    method6: "{{ bootstrap_ipv6_method | default('auto') }}"
    state: present
  when:
    - bootstrap_ipv6_dhcpv6 | default(false)

- name: Add static IPv6 address alongside SLAAC
  ansible.builtin.command:
    cmd: nmcli con mod "{{ _bootstrap_network_connection }}" +ipv6.addresses "{{ bootstrap_static_ip6 }}"
  register: _bootstrap_add_static_ipv6
  changed_when: _bootstrap_add_static_ipv6.rc == 0
  failed_when: false
  when:
    - bootstrap_ipv6_dhcpv6 | default(false)
    - bootstrap_static_ip6 | default('') | length > 0

- name: Disable IPv6 if not configured
  community.general.nmcli:
    conn_name: "{{ _bootstrap_network_connection }}"
    type: ethernet
    method6: disabled
    state: present
  when:
    - bootstrap_ipv6_disabled | default(false)
    - bootstrap_static_ip6 | default('') | length == 0
